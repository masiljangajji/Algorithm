name: Daily Algorithm Issue (cross repo)

on:
  push:
    branches:
      - main

jobs:
  daily-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Create or update today's issue in self-study (and close previous)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.SELF_STUDY_TOKEN }}
          script: |
            // ===== Config =====
            const sourceOwner   = context.repo.owner;              // ex) 'Masiljangajji'
            const sourceRepo    = context.repo.repo;               // ex) 'Algorithm'
            const targetOwner   = sourceOwner;                     
            const targetRepo    = 'self-study';                     // <-- ì´ìŠˆë¥¼ ìƒì„±í•  íƒ€ê¹ƒ ë¦¬í¬
            const dailyLabel    = 'algorithm-daily';                // êµ¬ë¶„ìš© ë¼ë²¨(ì„ íƒ)

            // ===== Helpers =====
            function kstDateString(d = new Date()) {
              const fmt = (opt) => new Intl.DateTimeFormat('ko-KR', { timeZone: 'Asia/Seoul', ...opt }).format(d);
              const y = fmt({ year: 'numeric' });
              const m = fmt({ month: '2-digit' });
              const day = fmt({ day: '2-digit' });
              return ${y}-${m}-${day};
            }

            const { repository, commits, pusher } = context.payload;

            if (!commits || commits.length === 0) {
              core.info('No commits in payload â€” skip.');
              return;
            }

            // ì†ŒìŠ¤(Algorithm) ì»¤ë°‹ HTML URL
            const sourceHtml = repository.html_url; // https://github.com/Masiljangajji/Algorithm

            const todayStr   = kstDateString();
            const issueTitle = ğŸ§© ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ í’€ì´ - ${todayStr};

            // 1) íƒ€ê¹ƒ ë¦¬í¬ì˜ ì—´ë¦° ì´ìŠˆ ëª©ë¡
            const openIssues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner: targetOwner, repo: targetRepo, state: 'open', per_page: 100 }
            );

            // 2) ì˜¤ëŠ˜ ì´ìŠˆ ì™¸ 'algorithm-daily' ë¼ë²¨ì´ ë¶™ì€ ì´ìŠˆëŠ” ëª¨ë‘ close
            for (const iss of openIssues) {
              const hasDaily = (iss.labels || []).some(l => (typeof l === 'string' ? l === dailyLabel : l.name === dailyLabel));
              if (hasDaily && iss.title !== issueTitle) {
                await github.rest.issues.update({
                  owner: targetOwner, repo: targetRepo, issue_number: iss.number, state: 'closed'
                });
                core.info(Closed previous daily issue #${iss.number}: ${iss.title});
              }
            }

            // 3) ì˜¤ëŠ˜ ì´ìŠˆ ì°¾ê¸° (ì—´ë¦° ê²ƒë¶€í„°)
            let todaysIssue = openIssues.find(i => i.title === issueTitle);

            // ë‹«íŒ ë™ì¼ ì œëª©ì´ ìˆìœ¼ë©´ ì¬ì˜¤í”ˆ(ì˜ˆì™¸ ì¼€ì´ìŠ¤ ë°©ì–´)
            if (!todaysIssue) {
              const closedIssues = await github.paginate(
                github.rest.issues.listForRepo,
                { owner: targetOwner, repo: targetRepo, state: 'closed', per_page: 100 }
              );
              const todaysClosed = closedIssues.find(i => i.title === issueTitle);
              if (todaysClosed) {
                await github.rest.issues.update({
                  owner: targetOwner, repo: targetRepo, issue_number: todaysClosed.number, state: 'open'
                });
                todaysIssue = (await github.rest.issues.get({
                  owner: targetOwner, repo: targetRepo, issue_number: todaysClosed.number
                })).data;
                core.info(Re-opened today's issue #${todaysIssue.number});
              }
            }

            // 4) ì˜¤ëŠ˜ ì´ìŠˆ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            if (!todaysIssue) {
              const body = [
                ## ${issueTitle},
                ,
                - ì‘ì„±ì: **${pusher?.name || 'unknown'}**,
                - ìƒì„± ì‹œê° (KST): ${kstDateString(new Date())},
                ,
                > í•˜ë£¨ ë™ì•ˆì˜ ë¬¸ì œ í’€ì´ ì»¤ë°‹ì´ ì´ ì´ìŠˆì— **ëŒ“ê¸€ë¡œ ëˆ„ì **ë©ë‹ˆë‹¤.,
                > ì†ŒìŠ¤ ë¦¬í¬: \${sourceOwner}/${sourceRepo}\
              ].join('\n');

              const created = await github.rest.issues.create({
                owner: targetOwner,
                repo: targetRepo,
                title: issueTitle,
                body,
                labels: [dailyLabel] // í•„ìš”ì—†ìœ¼ë©´ ì œê±°
              });
              todaysIssue = created.data;
              core.info(Created today's issue #${todaysIssue.number} in ${targetOwner}/${targetRepo});
            }

            // 5) ì´ë²ˆ pushì˜ ì»¤ë°‹ë“¤ì„ targetRepo ì´ìŠˆì— ëŒ“ê¸€ë¡œ ì¶”ê°€
            const nowKST = kstDateString(new Date());
            const lines = [];
            lines.push(### ğŸ”— Push (KST: ${nowKST}) â€” from \${sourceOwner}/${sourceRepo}\);
            lines.push('');

            for (const c of commits) {
              const shortSha  = c.id.substring(0, 8);
              const commitUrl = ${sourceHtml}/commit/${c.id};
              const firstLine = (c.message || '').split(/\r?\n/)[0];
              lines.push(- [\${shortSha}\](${commitUrl}) ${firstLine});
            }

            lines.push('');
            lines.push('<details><summary>ğŸ“ Full Commit Messages</summary>');
            lines.push('');
            for (const c of commits) {
              const commitUrl = ${sourceHtml}/commit/${c.id};
              lines.push(**Commit:** ${commitUrl});
              lines.push('');
              lines.push(c.message || '');
              lines.push('');
            }
            lines.push('</details>');

            await github.rest.issues.createComment({
              owner: targetOwner,
              repo: targetRepo,
              issue_number: todaysIssue.number,
              body: lines.join('\n')
            });

            core.info(Updated issue #${todaysIssue.number} in ${targetOwner}/${targetRepo}: ${issueTitle});